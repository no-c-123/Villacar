---
interface Props {
  price: number;
}

const { price } = Astro.props;
---

<div class="bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl p-8 border border-gray-100">
  <div class="flex items-center gap-3 mb-6">
    <div class="w-12 h-12 bg-gradient-to-br from-custom-red to-red-700 rounded-xl flex items-center justify-center">
      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
      </svg>
    </div>
    <div>
      <h3 class="text-2xl font-bold text-gray-900">Payment Calculator</h3>
      <p class="text-sm text-gray-600">Estimate your monthly payments</p>
    </div>
  </div>

  <div class="space-y-6">
    <!-- Vehicle Price -->
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">Vehicle Price</label>
      <input 
        type="number" 
        id="vehiclePrice" 
        value={price}
        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-custom-red focus:ring-2 focus:ring-custom-red/20 transition-all duration-200"
      />
    </div>

    <!-- Down Payment -->
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">
        Down Payment <span class="text-gray-500 font-normal">(${Math.round(price * 0.2).toLocaleString()} recommended)</span>
      </label>
      <input 
        type="number" 
        id="downPayment" 
        value={Math.round(price * 0.2)}
        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-custom-red focus:ring-2 focus:ring-custom-red/20 transition-all duration-200"
      />
      <input 
        type="range" 
        id="downPaymentSlider" 
        min="0" 
        max={price}
        value={Math.round(price * 0.2)}
        class="w-full mt-3 accent-custom-red"
      />
    </div>

    <!-- Interest Rate -->
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">Interest Rate (%)</label>
      <input 
        type="number" 
        id="interestRate" 
        value="6.5"
        step="0.1"
        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-custom-red focus:ring-2 focus:ring-custom-red/20 transition-all duration-200"
      />
    </div>

    <!-- Loan Term -->
    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-2">Loan Term (months)</label>
      <div class="grid grid-cols-4 gap-2">
        <button class="loan-term-btn px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-custom-red transition-all duration-200" data-term="36">36</button>
        <button class="loan-term-btn px-4 py-3 border-2 border-custom-red bg-custom-red text-white rounded-xl" data-term="48">48</button>
        <button class="loan-term-btn px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-custom-red transition-all duration-200" data-term="60">60</button>
        <button class="loan-term-btn px-4 py-3 border-2 border-gray-200 rounded-xl hover:border-custom-red transition-all duration-200" data-term="72">72</button>
      </div>
      <input type="hidden" id="loanTerm" value="48" />
    </div>

    <!-- Results -->
    <div class="bg-gradient-to-br from-custom-red to-red-700 rounded-2xl p-6 text-white">
      <div class="text-center">
        <p class="text-sm opacity-90 mb-2">Estimated Monthly Payment</p>
        <p class="text-5xl font-bold mb-1" id="monthlyPayment">$0</p>
        <p class="text-sm opacity-75">per month for <span id="termDisplay">48</span> months</p>
      </div>
      
      <div class="grid grid-cols-3 gap-4 mt-6 pt-6 border-t border-white/20">
        <div class="text-center">
          <p class="text-xs opacity-75 mb-1">Total Loan</p>
          <p class="font-bold" id="totalLoan">$0</p>
        </div>
        <div class="text-center">
          <p class="text-xs opacity-75 mb-1">Total Interest</p>
          <p class="font-bold" id="totalInterest">$0</p>
        </div>
        <div class="text-center">
          <p class="text-xs opacity-75 mb-1">Total Cost</p>
          <p class="font-bold" id="totalCost">$0</p>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="flex gap-3">
      <a href="/contact" class="flex-1 bg-gradient-to-r from-custom-red to-red-700 text-white px-6 py-3 rounded-xl font-semibold hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 text-center">
        Apply for Financing
      </a>
      <a href="/contact?subject=payment-inquiry" class="flex-1 border-2 border-custom-red text-custom-red px-6 py-3 rounded-xl font-semibold hover:bg-custom-red hover:text-white transition-all duration-200 text-center">
        Ask Questions
      </a>
    </div>

    <p class="text-xs text-gray-500 text-center">
      * This calculator provides estimates only. Actual payments may vary based on credit approval and final terms.
    </p>
  </div>
</div>

<script>
  function calculatePayment() {
    const price = parseFloat((document.getElementById('vehiclePrice') as HTMLInputElement).value) || 0;
    const downPayment = parseFloat((document.getElementById('downPayment') as HTMLInputElement).value) || 0;
    const interestRate = parseFloat((document.getElementById('interestRate') as HTMLInputElement).value) || 0;
    const loanTerm = parseInt((document.getElementById('loanTerm') as HTMLInputElement).value) || 48;
    
    const loanAmount = price - downPayment;
    const monthlyRate = (interestRate / 100) / 12;
    
    let monthlyPayment = 0;
    if (monthlyRate === 0) {
      monthlyPayment = loanAmount / loanTerm;
    } else {
      monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, loanTerm)) / (Math.pow(1 + monthlyRate, loanTerm) - 1);
    }
    
    const totalPayment = monthlyPayment * loanTerm;
    const totalInterest = totalPayment - loanAmount;
    const totalCost = totalPayment + downPayment;
    
    document.getElementById('monthlyPayment')!.textContent = '$' + Math.round(monthlyPayment).toLocaleString();
    document.getElementById('totalLoan')!.textContent = '$' + Math.round(loanAmount).toLocaleString();
    document.getElementById('totalInterest')!.textContent = '$' + Math.round(totalInterest).toLocaleString();
    document.getElementById('totalCost')!.textContent = '$' + Math.round(totalCost).toLocaleString();
    document.getElementById('termDisplay')!.textContent = loanTerm.toString();
  }
  
  // Initialize calculation
  calculatePayment();
  
  // Event listeners
  document.getElementById('vehiclePrice')?.addEventListener('input', calculatePayment);
  document.getElementById('downPayment')?.addEventListener('input', function() {
    const downPayment = parseFloat((this as HTMLInputElement).value) || 0;
    (document.getElementById('downPaymentSlider') as HTMLInputElement).value = downPayment.toString();
    calculatePayment();
  });
  
  document.getElementById('downPaymentSlider')?.addEventListener('input', function() {
    const downPayment = parseFloat((this as HTMLInputElement).value) || 0;
    (document.getElementById('downPayment') as HTMLInputElement).value = Math.round(downPayment).toString();
    calculatePayment();
  });
  
  document.getElementById('interestRate')?.addEventListener('input', calculatePayment);
  
  document.querySelectorAll('.loan-term-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      const target = e.currentTarget;
      if (!target || !(target instanceof HTMLElement)) return;
      
      document.querySelectorAll('.loan-term-btn').forEach(b => {
        b.classList.remove('border-custom-red', 'bg-custom-red', 'text-white');
        b.classList.add('border-gray-200');
      });
      target.classList.add('border-custom-red', 'bg-custom-red', 'text-white');
      target.classList.remove('border-gray-200');
      
      const term = target.getAttribute('data-term') || '48';
      (document.getElementById('loanTerm') as HTMLInputElement).value = term;
      calculatePayment();
    });
  });
</script>
