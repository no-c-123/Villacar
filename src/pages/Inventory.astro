---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import { cars, type Car } from '../data/cars';
---

<Layout 
  title="Inventory - Villacar Autos LLC. | Browse Our Vehicle Selection"
  description="Explore our inventory of quality vehicles from trusted brands like Nissan, Dodge, GMC, Toyota, and more. Find the perfect car for your needs and budget."
>
  <Navbar />
  
  <main class="min-h-screen bg-gray-50">
    <!-- Page Header -->
    <section class="bg-gradient-to-br from-gray-900 to-gray-800 py-20">
      <div class="container mx-auto px-4">
        <h1 class="text-5xl md:text-6xl font-bold text-white mb-6 text-center">
          Our <span class="text-red-400">Inventory</span>
        </h1>
        <p class="text-xl text-gray-300 text-center max-w-3xl mx-auto mb-10">
          Browse our selection of quality vehicles from Nissan, Dodge, GMC, Toyota, and more
        </p>

        <!-- Filter Bar -->
        <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl p-6">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <select id="makeFilter" class="px-4 py-3 rounded-lg border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
              <option value="">All Makes</option>
              <option value="Toyota">Toyota</option>
              <option value="Nissan">Nissan</option>
              <option value="GMC">GMC</option>
              <option value="Dodge">Dodge</option>
            </select>
            
            <select id="typeFilter" class="px-4 py-3 rounded-lg border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
              <option value="">All Types</option>
              <option value="Sedan">Sedan</option>
              <option value="SUV">SUV</option>
              <option value="Truck">Truck</option>
            </select>
            
            <select id="yearFilter" class="px-4 py-3 rounded-lg border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
              <option value="">All Years</option>
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
              <option value="2022">2022 & Older</option>
            </select>
            
            <select id="priceFilter" class="px-4 py-3 rounded-lg border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
              <option value="">Max Price</option>
              <option value="25000">Under $25,000</option>
              <option value="35000">Under $35,000</option>
              <option value="50000">Under $50,000</option>
              <option value="999999">$50,000+</option>
            </select>
            
            <button id="resetFilters" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-300 font-semibold flex items-center justify-center">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Reset
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Car Grid -->
    <section class="py-16">
      <div class="container mx-auto px-4">
        <div class="flex flex-wrap justify-between items-center mb-8">
          <p class="text-gray-700 text-lg">
            Showing <span id="vehicleCount" class="font-bold text-gray-900">{cars.length}</span> vehicles
          </p>
          <div class="flex items-center space-x-4">
            <a 
              href="/compare" 
              class="inline-flex items-center gap-2 px-6 py-2 border-2 border-custom-red text-custom-red rounded-lg hover:bg-custom-red hover:text-white transition-all duration-200 font-semibold"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
              Compare Vehicles
            </a>
            <label class="text-gray-700">Sort by:</label>
            <select id="sortSelect" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-500">
              <option value="price-low">Price: Low to High</option>
              <option value="price-high">Price: High to Low</option>
              <option value="year-new">Year: Newest First</option>
              <option value="mileage-low">Mileage: Low to High</option>
            </select>
          </div>
        </div>

        <div id="carGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
          {cars.map((car) => (
            <a href={`/cars/${car.id}`} class="car-item group" 
               data-make={car.make}
               data-type={car.bodyType}
               data-year={car.year}
               data-price={car.price}
               data-mileage={car.mileage}>
              <div class="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2">
                <div class="relative overflow-hidden h-56">
                  <img 
                    src={car.images[0]} 
                    alt={`${car.year} ${car.make} ${car.model}`}
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                  />
                  <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                  
                  {/* Badges */}
                  <div class="absolute top-4 right-4 flex flex-col gap-2">
                    <span class={`px-4 py-2 rounded-full text-xs font-bold shadow-lg backdrop-blur-sm ${
                      car.condition === 'New' ? 'bg-green-600 text-white' :
                      car.condition === 'Certified' ? 'bg-blue-600 text-white' :
                      'bg-gray-700 text-white'
                    }`}>
                      {car.condition}
                    </span>
                  </div>

                  {/* Wishlist Button */}
                  <button 
                    class="wishlist-btn absolute top-4 left-4 w-10 h-10 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center shadow-lg hover:bg-white transition-all duration-200 z-10 group/wishlist"
                    data-car-id={car.id}
                    onclick="event.preventDefault(); toggleWishlist(this);"
                    aria-label="Add to wishlist"
                  >
                    <svg class="wishlist-icon w-5 h-5 text-gray-600 group-hover/wishlist:text-red-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                  </button>

                  {/* Quick View Overlay */}
                  <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <span class="px-6 py-3 bg-white text-red-600 rounded-full font-bold shadow-xl transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                      View Details →
                    </span>
                  </div>
                </div>

                <div class="p-6">
                  <h3 class="text-xl font-bold text-gray-900 mb-3 group-hover:text-red-600 transition-colors">
                    {car.year} {car.make} {car.model}
                  </h3>

                  <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                    <div class="flex items-center text-gray-600">
                      <svg class="w-4 h-4 mr-1 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      {car.mileage.toLocaleString()} mi
                    </div>
                    <div class="flex items-center text-gray-600">
                      <svg class="w-4 h-4 mr-1 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                      </svg>
                      {car.fuelType}
                    </div>
                    <div class="flex items-center text-gray-600">
                      <svg class="w-4 h-4 mr-1 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                      {car.transmission}
                    </div>
                    <div class="flex items-center text-gray-600">
                      <svg class="w-4 h-4 mr-1 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                      </svg>
                      {car.bodyType}
                    </div>
                  </div>

                  <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                    <div>
                      <p class="text-xs text-gray-500 mb-1">Starting at</p>
                      <span class="text-2xl font-bold text-red-600">
                        ${car.price.toLocaleString()}
                      </span>
                    </div>
                    <div class="flex items-center text-red-600 font-semibold">
                      <span class="group-hover:translate-x-1 transition-transform">→</span>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          ))}
        </div>

        {/* Call to Action */}
        <div class="mt-16 text-center bg-gradient-to-r from-red-600 to-red-700 rounded-2xl p-12 text-white">
          <h3 class="text-3xl font-bold mb-4">Didn't Find What You're Looking For?</h3>
          <p class="text-lg mb-8 text-red-100">Let us know what you need and we'll help you find it!</p>
          <a 
            href="/contact" 
            class="inline-block px-8 py-4 bg-white text-red-600 rounded-xl hover:bg-gray-100 transition-all duration-300 font-bold text-lg shadow-lg"
          >
            Contact Us Today
          </a>
        </div>
      </div>
    </section>
  </main>

  <Footer />

  <script>
    // Wishlist functionality
    function getWishlist() {
      return JSON.parse(localStorage.getItem('wishlist') || '[]');
    }

    function saveWishlist(wishlist: string[]) {
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
    }

    function updateAllWishlistButtons() {
      const wishlist = getWishlist();
      document.querySelectorAll('.wishlist-btn').forEach(btn => {
        const carId = btn.getAttribute('data-car-id');
        const icon = btn.querySelector('.wishlist-icon');
        if (wishlist.includes(carId || '')) {
          icon?.setAttribute('fill', 'currentColor');
          icon?.classList.add('text-red-600');
        } else {
          icon?.setAttribute('fill', 'none');
          icon?.classList.remove('text-red-600');
        }
      });
    }

    // @ts-ignore - Adding function to window for onclick handlers
    window.toggleWishlist = function(btn) {
      const carId = btn.getAttribute('data-car-id');
      let wishlist = getWishlist();
      
      if (wishlist.includes(carId || '')) {
        // @ts-ignore
        wishlist = wishlist.filter(id => id !== carId);
      } else {
        wishlist.push(carId);
      }
      
      saveWishlist(wishlist);
      updateAllWishlistButtons();
    };

    updateAllWishlistButtons();

    // Get all car items and filters
    const carItems = document.querySelectorAll('.car-item');
    const makeFilter = document.getElementById('makeFilter') as HTMLSelectElement;
    const typeFilter = document.getElementById('typeFilter') as HTMLSelectElement;
    const yearFilter = document.getElementById('yearFilter') as HTMLSelectElement;
    const priceFilter = document.getElementById('priceFilter') as HTMLSelectElement;
    const sortSelect = document.getElementById('sortSelect') as HTMLSelectElement;
    const resetButton = document.getElementById('resetFilters');
    const vehicleCount = document.getElementById('vehicleCount');
    const carGrid = document.getElementById('carGrid');

    function filterAndSortCars() {
      const selectedMake = makeFilter?.value || '';
      const selectedType = typeFilter?.value || '';
      const selectedYear = yearFilter?.value || '';
      const selectedPrice = priceFilter?.value || '';
      const sortBy = sortSelect?.value || 'price-low';

      let visibleCars: HTMLElement[] = [];
      let visibleCount = 0;

      // Filter cars
      carItems.forEach((item) => {
        const carElement = item as HTMLElement;
        const make = carElement.dataset.make || '';
        const type = carElement.dataset.type || '';
        const year = parseInt(carElement.dataset.year || '0');
        const price = parseInt(carElement.dataset.price || '0');

        let show = true;

        // Apply make filter
        if (selectedMake && make !== selectedMake) {
          show = false;
        }

        // Apply type filter
        if (selectedType && type !== selectedType) {
          show = false;
        }

        // Apply year filter
        if (selectedYear) {
          if (selectedYear === '2022') {
            if (year > 2022) show = false;
          } else {
            if (year !== parseInt(selectedYear)) show = false;
          }
        }

        // Apply price filter
        if (selectedPrice) {
          if (price > parseInt(selectedPrice)) {
            show = false;
          }
        }

        if (show) {
          carElement.style.display = 'block';
          visibleCars.push(carElement);
          visibleCount++;
        } else {
          carElement.style.display = 'none';
        }
      });

      // Sort visible cars
      visibleCars.sort((a, b) => {
        const priceA = parseInt(a.dataset.price || '0');
        const priceB = parseInt(b.dataset.price || '0');
        const yearA = parseInt(a.dataset.year || '0');
        const yearB = parseInt(b.dataset.year || '0');
        const mileageA = parseInt(a.dataset.mileage || '0');
        const mileageB = parseInt(b.dataset.mileage || '0');

        switch (sortBy) {
          case 'price-low':
            return priceA - priceB;
          case 'price-high':
            return priceB - priceA;
          case 'year-new':
            return yearB - yearA;
          case 'mileage-low':
            return mileageA - mileageB;
          default:
            return 0;
        }
      });

      // Reorder DOM elements
      visibleCars.forEach(car => {
        carGrid?.appendChild(car);
      });

      // Update count
      if (vehicleCount) {
        vehicleCount.textContent = visibleCount.toString();
      }

      // Show/hide no results message
      const noResultsId = 'noResults';
      let noResults = document.getElementById(noResultsId);
      
      if (visibleCount === 0) {
        if (!noResults) {
          noResults = document.createElement('div');
          noResults.id = noResultsId;
          noResults.className = 'col-span-full text-center py-16';
          noResults.innerHTML = `
            <div class="max-w-md mx-auto">
              <svg class="w-24 h-24 text-gray-300 mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <h3 class="text-2xl font-bold text-gray-900 mb-2">No vehicles found</h3>
              <p class="text-gray-600 mb-6">Try adjusting your filters to see more results</p>
              <button id="resetFromNoResults" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-300 font-semibold">
                Reset Filters
              </button>
            </div>
          `;
          carGrid?.appendChild(noResults);
          
          // Add event listener to the new reset button
          document.getElementById('resetFromNoResults')?.addEventListener('click', resetFilters);
        }
      } else if (noResults) {
        noResults.remove();
      }
    }

    function resetFilters() {
      if (makeFilter) makeFilter.value = '';
      if (typeFilter) typeFilter.value = '';
      if (yearFilter) yearFilter.value = '';
      if (priceFilter) priceFilter.value = '';
      if (sortSelect) sortSelect.value = 'price-low';
      filterAndSortCars();
    }

    // Add event listeners
    makeFilter?.addEventListener('change', filterAndSortCars);
    typeFilter?.addEventListener('change', filterAndSortCars);
    yearFilter?.addEventListener('change', filterAndSortCars);
    priceFilter?.addEventListener('change', filterAndSortCars);
    sortSelect?.addEventListener('change', filterAndSortCars);
    resetButton?.addEventListener('click', resetFilters);

    // Initial sort on page load
    filterAndSortCars();
  </script>
</Layout>
